<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打刻アプリ</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button { font-size: 1.2rem; padding: 15px 30px; margin: 10px; width: 80%; max-width: 300px; cursor: pointer; }
        #status { margin-top: 20px; color: blue; }
        .hidden { display: none; }
        #userInfo { margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>勤怠打刻</h1>
    
    <div id="loginSection">
        <p>利用にはGoogleログインが必要です</p>
        <button onclick="login()">Googleでログイン</button>
    </div>

    <div id="mainSection" class="hidden">
        <div id="userInfo"></div>
        <button onclick="sendData('出勤')" style="background-color: #e0f7fa;">出勤</button><br>
        <button onclick="sendData('退勤')" style="background-color: #ffebee;">退勤</button>
    </div>

    <p id="status"></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ▼▼▼ 書き換えここから（ステップ2で控えたデータ） ▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyDxeWz_xvG-Ey0L8-kRFpESAtis72Bz-Ck",
          authDomain: "timecardapp-57696.firebaseapp.com",
          projectId: "timecardapp-57696",
          storageBucket: "timecardapp-57696.firebasestorage.app",
          messagingSenderId: "511363205794",
          appId: "1:511363205794:web:a150936b46060bffd7e5fb"
        };
        // ▲▲▲ 書き換えここまで ▲▲▲

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // ログイン処理
        window.login = () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    document.getElementById("status").innerText = "ログイン成功";
                }).catch((error) => {
                    console.error(error);
                    alert("ログイン失敗: " + error.message);
                });
        };

        // ログイン状態監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("mainSection").classList.remove("hidden");
                document.getElementById("userInfo").innerText = `ログイン中: ${user.displayName}`;
                window.currentUser = user; // ユーザー情報をグローバル変数に保持
            }
        });
    </script>

    <script>
        // ▼▼▼ 書き換えここから（ステップ1で控えたGASのURL） ▼▼▼
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyKMSSVhWnQXj7Uv5_DiSRWe7bbmA5bL7XaMEhNpdh6CUl-nzKKjRTLJXzb8dSrgI4e/exec";
        // ▲▲▲ 書き換えここまで ▲▲▲

        function sendData(type) {
            const statusEl = document.getElementById("status");
            statusEl.innerText = "位置情報を取得中...";

            if (!navigator.geolocation) {
                alert("この端末では位置情報が使えません");
                return;
            }

            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const user = window.currentUser;

                statusEl.innerText = "送信中...";

                const payload = {
                    name: user.displayName,
                    email: user.email,
                    type: type,
                    lat: lat,
                    lon: lon
                };

                // GASへ送信（no-corsモードで送信）
                fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).then(() => {
                    statusEl.innerText = type + "打刻が完了しました！";
                    setTimeout(() => statusEl.innerText = "", 3000);
                }).catch((err) => {
                    statusEl.innerText = "送信エラー";
                    console.error(err);
                });

            }, (error) => {
                statusEl.innerText = "位置情報の取得に失敗しました";
                alert("位置情報の利用を許可してください");
            });
        }
    </script>
</body>
</html>
