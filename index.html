<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打刻アプリ</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button { font-size: 1.2rem; padding: 15px 30px; margin: 10px; width: 80%; max-width: 300px; cursor: pointer; }
        #status { margin-top: 20px; color: blue; }
        .hidden { display: none; }
        #userInfo { margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>勤怠打刻</h1>
    
    <div id="loginSection">
        <p>利用にはGoogleログインが必要です</p>
        <button onclick="login()">Googleでログイン</button>
    </div>

    <div id="mainSection" class="hidden">
        <div id="userInfo"></div>
        <button onclick="sendData('出勤')" style="background-color: #e0f7fa;">出勤</button><br>
        <button onclick="sendData('退勤')" style="background-color: #ffebee;">退勤</button>
    </div>

    <p id="status"></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ▼▼▼ 書き換えここから（ステップ2で控えたデータ） ▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyDxeWz_xvG-Ey0L8-kRFpESAtis72Bz-Ck",
          authDomain: "timecardapp-57696.firebaseapp.com",
          projectId: "timecardapp-57696",
          storageBucket: "timecardapp-57696.firebasestorage.app",
          messagingSenderId: "511363205794",
          appId: "1:511363205794:web:a150936b46060bffd7e5fb"
        };
        // ▲▲▲ 書き換えここまで ▲▲▲

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // ログイン処理
        window.login = () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    document.getElementById("status").innerText = "ログイン成功";
                }).catch((error) => {
                    console.error(error);
                    alert("ログイン失敗: " + error.message);
                });
        };

        // ログイン状態監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("mainSection").classList.remove("hidden");
                document.getElementById("userInfo").innerText = `ログイン中: ${user.displayName}`;
                window.currentUser = user; // ユーザー情報をグローバル変数に保持
            }
        });
    </script>

    <script>
        // ▼▼▼ 書き換えここから（ステップ1で控えたGASのURL） ▼▼▼
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyKMSSVhWnQXj7Uv5_DiSRWe7bbmA5bL7XaMEhNpdh6CUl-nzKKjRTLJXzb8dSrgI4e/exec";
        // ▲▲▲ 書き換えここまで ▲▲▲

    // ▼▼▼ 追加：オフィスの設定（ステップ1で調べた数値をここに入れる） ▼▼▼
        const OFFICE_LAT = 35.681234;  // オフィスの緯度
        const OFFICE_LON = 139.767123; // オフィスの経度
        const ALLOWED_DISTANCE = 50;   // 許容する半径（メートル）※GPS誤差を考慮して50m〜100m推奨
    
        // 2点間の距離を計算する関数（ハーバースイン公式）
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // 地球の半径（メートル）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // 距離（メートル）
        }
    
        function sendData(type) {
            const statusEl = document.getElementById("status");
            statusEl.innerText = "位置情報を取得中...";
            statusEl.style.color = "blue";
    
            if (!navigator.geolocation) {
                alert("この端末では位置情報が使えません");
                return;
            }
    
            navigator.geolocation.getCurrentPosition((position) => {
                const currentLat = position.coords.latitude;
                const currentLon = position.coords.longitude;
                
                // ▼▼▼ 追加：距離判定ロジック ▼▼▼
                const distance = getDistance(currentLat, currentLon, OFFICE_LAT, OFFICE_LON);
                console.log("オフィスまでの距離: " + Math.round(distance) + "m");
    
                // 許容範囲を超えていたら送信せずに終了
                if (distance > ALLOWED_DISTANCE) {
                    statusEl.innerText = `オフィスから離れすぎています（距離:約${Math.round(distance)}m）`;
                    statusEl.style.color = "red";
                    alert(`オフィス周辺（半径${ALLOWED_DISTANCE}m以内）から打刻してください。\n現在地からの距離: 約${Math.round(distance)}m`);
                    return; // ここで処理を中断
                }
                // ▲▲▲ 追加ここまで ▲▲▲
    
                // ここから下は前回と同じ（送信処理）
                const user = window.currentUser;
                statusEl.innerText = "送信中...";
    
                const payload = {
                    name: user.displayName,
                    email: user.email,
                    type: type,
                    lat: currentLat,
                    lon: currentLon
                };
    
                fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).then(() => {
                    statusEl.innerText = type + "打刻が完了しました！";
                    setTimeout(() => statusEl.innerText = "", 3000);
                }).catch((err) => {
                    statusEl.innerText = "送信エラー";
                    console.error(err);
                });
    
            }, (error) => {
                statusEl.innerText = "位置情報の取得に失敗しました";
                alert("位置情報の利用を許可してください");
            });
        }
        </script>
</body>
</html>
